// Generated by CoffeeScript 1.8.0
(function() {
  var analyser, context, getFreq, hue, init, input, ip, user;

  init = function(callback) {
    var AudioContext, context, e;
    if (callback == null) {
      callback = function() {};
    }
    try {
      AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();
      return callback(null, context);
    } catch (_error) {
      e = _error;
      return callback('Web Audio API is not suppported in this browser');
    }
  };

  navigator.getUserMedia = navigator.webkitGetUserMedia;

  context = null;

  analyser = null;

  input = null;

  hue = null;

  ip = '192.168.1.100';

  user = 'newdeveloper';

  getFreq = null;

  window.onload = function() {
    init(function(err, con) {
      if (err) {
        alert(err);
        return;
      }
      context = con;
      analyser = context.createAnalyser();
      analyser.fftsize = 1024;
      return analyser.smoothingTimeContant = 0.9;
    });
    hue = new HueController(ip, user);
    hue.changeBri(3, 255).then(function(result) {
      return console.log('onloaded');
    }).fail(function(err) {
      return console.log(err);
    });
    return $('.analyser').append('<div id="volume"></div>');
  };

  $('.start').click(function() {
    if (!navigator.getUserMedia) {
      return alert('WebRTC(getUserMedia) is not suppported...');
    } else {
      console.log('getUserMedia suppported.');
      return navigator.getUserMedia({
        audio: true
      }, function(stream) {
        input = context.createMediaStreamSource(stream);
        return input.connect(analyser);
      }, function(err) {
        return console.log('Error: ' + err);
      });
    }
  });

  getFreq = function() {
    var data, i, sum, _i;
    data = new Uint8Array(256);
    analyser.getByteFrequencyData(data);
    sum = 0;
    for (i = _i = 0; _i <= 255; i = ++_i) {
      sum += data[i];
    }
    return hue.lightTrriger(3, parseInt(sum / 256) > 75).then(function(result) {
      console.log(result);
      console.log(parseInt(sum / 255));
      return $('#volume').text((sum / 255).toString());
    }).fail(function(err) {
      return console.log(err);
    });
  };

  setInterval(getFreq, 80);

}).call(this);
